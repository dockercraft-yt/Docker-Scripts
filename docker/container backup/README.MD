# ğŸ³ Docker Stack Backup â€“ Dokumentation

**Version:** 1.8  
**Stand:** 18.10.2025  
**Autor:** Dockercraft  

---

## ğŸ“‹ Ãœbersicht

Dieses Skript dient zur **automatisierten Sicherung von Docker Compose Stacks**, inklusive optionaler Sicherung der persistenten Daten.  
Es ist fÃ¼r den wÃ¶chentlichen Betrieb Ã¼ber `cron` ausgelegt und bietet robuste Fehlerbehandlung, Logging und konfigurierbares Verhalten.

---

### Inhaltsverzeichnis
- [ğŸ³ Docker Stack Backup â€“ Dokumentation](#-docker-stack-backup--dokumentation)
  - [ğŸ“‹ Ãœbersicht](#-Ã¼bersicht)
    - [Inhaltsverzeichnis](#inhaltsverzeichnis)
  - [âš™ï¸ Aufbau](#ï¸-aufbau)
    - [1. Hauptskript](#1-hauptskript)
    - [2. Konfigurationsdatei](#2-konfigurationsdatei)
  - [ğŸ—“ï¸ Verwendung im Cron](#ï¸-verwendung-im-cron)
    - [Beispiel Cronjob (wÃ¶chentliche Sicherung)](#beispiel-cronjob-wÃ¶chentliche-sicherung)
  - [ğŸ” Funktionsweise](#-funktionsweise)
  - [ğŸ§± Verhalten je nach Stack-Zustand](#-verhalten-je-nach-stack-zustand)
  - [ğŸ“¦ Backup-Struktur](#-backup-struktur)
  - [ğŸ§¹ Logrotation \& Aufbewahrung](#-logrotation--aufbewahrung)
  - [ğŸ§ª Testlauf](#-testlauf)
  - [ğŸ§° Hinweise](#-hinweise)
  - [âœ… Beispiel: Manuelles Restore (nur zur Referenz)](#-beispiel-manuelles-restore-nur-zur-referenz)
  - [ğŸ§¾ Ã„nderungsverlauf](#-Ã¤nderungsverlauf)


## âš™ï¸ Aufbau

### 1. Hauptskript

Pfad:  
`/opt/scripts/backup.sh`

Dieses Skript:
- sichert alle Stacks unter `/opt/stacks/[STACKNAME]/`
- erstellt komprimierte Backups (`.tar.gz`) im definierten Backup-Verzeichnis
- optional: sichert persistente Daten (alle Unterordner)
- fÃ¼hrt ein Logging mit Datum und Rotation durch
- startet nur Container neu, die vor dem Backup aktiv waren

### 2. Konfigurationsdatei

Pfad:  
`/opt/scripts/backup.conf`

Beispielinhalt:

```bash
#=============================================================================
#
# Docker Stack Backup Configuration
# #=============================================================================

# === Pfade ===
STACKS_DIR="/opt/stacks"
BACKUP_DIR="/opt/docker_backups"
LOG_DIR="/var/log/docker_backups"

# === Verhalten ===
INCLUDE_DATA=true           # true/false â†’ Soll der Data-Ordner gesichert werden?
RETENTION_DAYS=30           # Alte Backups lÃ¶schen nach X Tagen
LOG_RETENTION_DAYS=14       # Alte Logs lÃ¶schen nach X Tagen

# === Kritische Container (nicht stoppen / keine Daten sichern) ===
SKIP_STOP=("traefik" "portainer" "watchtower")
```

---

## ğŸ—“ï¸ Verwendung im Cron

### Beispiel Cronjob (wÃ¶chentliche Sicherung)

```bash
0 3 * * 0 /opt/scripts/backup.sh
```
â¡ LÃ¤uft **sonntags um 3 Uhr**  
â¡ Erstellt ein Logfile: `/var/log/docker_backups/backup_YYYY-MM-DD.log`  
â¡ Alte Logs & Backups werden automatisch gelÃ¶scht  

---

## ğŸ” Funktionsweise

| Schritt | Beschreibung |
|----------|---------------|
| 1ï¸âƒ£ | Erkennung aller Stacks unter `/opt/stacks` |
| 2ï¸âƒ£ | Sicherung der `compose.yaml` und `.env` Dateien |
| 3ï¸âƒ£ | Optional: Stoppen des Stacks und Backup der Unterordner |
| 4ï¸âƒ£ | Komprimierung der Sicherung zu `.tar.gz` |
| 5ï¸âƒ£ | Neustart nur, wenn Stack vorher aktiv war |
| 6ï¸âƒ£ | AufrÃ¤umen alter Backups und Logs |

---

## ğŸ§± Verhalten je nach Stack-Zustand

| Stack-Zustand | Verhalten beim Backup |
|----------------|-----------------------|
| **LÃ¤uft** | Stack wird gestoppt, gesichert und danach wieder gestartet |
| **Gestoppt** | Stack bleibt gestoppt, es erfolgt nur Dateisicherung |
| **In Skip-Liste** | Keine Stop-/Start-Aktion, nur Compose-Dateien werden gesichert |

---

## ğŸ“¦ Backup-Struktur

```
/opt/docker_backups/
â”œâ”€â”€ nextcloud_2025-10-13_03-00-00.tar.gz
â”œâ”€â”€ traefik_2025-10-13_03-00-00.tar.gz
â””â”€â”€ ...
```

Im Archiv enthalten:
```
compose.yaml
.env
[STACKNAME]_data.tar.gz (falls Daten gesichert)
```

---

## ğŸ§¹ Logrotation & Aufbewahrung

- Logs Ã¤lter als `LOG_RETENTION_DAYS` Tage werden automatisch gelÃ¶scht  
- Backups Ã¤lter als `RETENTION_DAYS` Tage werden automatisch entfernt  

---

## ğŸ§ª Testlauf

Vor der ersten Verwendung sollte das Skript **manuell getestet** werden:

```bash
sudo bash /opt/scripts/docker_backup.sh
```

Die Logausgabe wird dabei in die Konsole und ins Logfile geschrieben.

---

## ğŸ§° Hinweise

- Das Skript benÃ¶tigt `docker compose` (nicht `docker-compose`)
- Achte auf ausreichenden Speicherplatz im Backup-Verzeichnis
- ÃœberprÃ¼fe regelmÃ¤ÃŸig die Logdateien auf Fehler oder Warnungen
- Restore erfolgt **manuell** Ã¼ber Entpacken und Starten des Stacks

---

## âœ… Beispiel: Manuelles Restore (nur zur Referenz)

```bash
tar -xzf /opt/docker_backups/nextcloud_2025-10-13_03-00-00.tar.gz -C /opt/stacks/
cd /opt/stacks/nextcloud
docker compose up -d
```

---

## ğŸ§¾ Ã„nderungsverlauf

| Version | Datum | Ã„nderung |
|----------|--------|-----------|
| 1.0 | Initial | Grundlegende Backup-Funktion |
| 1.5 | Logging & Config ausgelagert | EinfÃ¼hrung der Config-Datei |
| 1.7 | Kritische Container | Ausschluss von Containergruppen |
| 1.8 | Smart Restart | Containerzustand wird berÃ¼cksichtigt |

---